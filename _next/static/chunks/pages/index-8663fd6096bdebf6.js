(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{5557:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return t(2362)}])},2362:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return y}});var r=t(7568),s=t(1438),c=t(2951),a=t(8029),i=t(6567),o=t(4051),u=t.n(o),l=t(5893),p=t(9008),d=t.n(p),f=t(7294),h=t(6312),v=t(2893),x=t(4924),m=t(6042),g=t(7229),w=t(6624),b=function(){function e(n){(0,s.Z)(this,e),(0,x.Z)(this,"regexList",[RegExp("^stunnelv1\\.0\\/(?<group>.+?)\\/(?<device>.+?)\\/(?<uuid>.+)\\/(?<session>.+)\\/(?<action>.+)$"),RegExp("^stunnelv1\\.0\\/(?<group>.+?)\\/(?<device>.+?)\\/state$")]),this.sessionMap={},this.groupDeviceMap={},this.mqttConnStr=n||"wss://10.123.12.140:8084/mqtt",this.connceted=!1}return(0,c.Z)(e,[{key:"createSession",value:function(e,n,t,s){var c=this;return(0,r.Z)(u().mark((function a(){var i,o;return u().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return console.log("createSession [".concat(e,"/").concat(n,"] mqtt://").concat(s)),i=window.crypto.randomUUID(),c.sessionMap[i]={uuid:i,group:e,device:n,term:t,mqttClient:g.connect(s,{keepalive:60,will:{topic:"stunnelv1.0/".concat(e,"/").concat(n,"/").concat(i,"/logout"),payload:null,qos:1}}),write:[],read:[]},(o=c.sessionMap[i]).mqttClient.on("message",function(){var e=(0,r.Z)(u().mark((function e(n,t){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o.term){e.next=4;break}return console.log("session.term not existed. buffering..."),o.write.push(t.toString()),e.abrupt("return");case 4:return e.next=6,o.term.write(o.write.join(""));case 6:return o.write.length=0,e.next=9,o.term.write(t.toString());case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}()),a.next=7,o.mqttClient.subscribe("stunnelv1.0/".concat(e,"/").concat(n,"/").concat(i,"/1/out"));case 7:return a.next=9,o.mqttClient.publish("stunnelv1.0/".concat(o.group,"/").concat(o.device,"/").concat(i,"/login"),JSON.stringify({id:i,online:!0,maxPacketSize:0,sshDirect:!0}));case 9:return a.abrupt("return",o);case 10:case"end":return a.stop()}}),a)})))()}},{key:"destroySession",value:function(e){var n=this;return(0,r.Z)(u().mark((function t(){var r;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("destroySession",e),r=n.sessionMap[e],t.next=4,r.mqttClient.publish("stunnelv1.0/".concat(r.group,"/").concat(r.device,"/").concat(e,"/logout"),null);case 4:return t.next=6,r.mqttClient.end();case 6:r.term.reset(),delete n.sessionMap[e];case 8:case"end":return t.stop()}}),t)})))()}},{key:"scan",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){var t;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log("scan started."),t=g.connect(e.mqttConnStr),n.abrupt("return",new w((function(n,s){t.on("connect",(0,r.Z)(u().mark((function r(){return u().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return console.log("Broker connected."),r.prev=1,r.next=4,t.subscribe("stunnelv1.0/+/+/state");case 4:r.next=11;break;case 6:r.prev=6,r.t0=r.catch(1),s(r.t0),t.end(),console.log("scan ended.");case 11:console.log("topic [stunnelv1.0/+/+/state] subscribed."),setTimeout((function(){n(e.groupDeviceMap),t.end()}),3e3);case 13:case"end":return r.stop()}}),r,null,[[1,6]])})))),t.on("message",function(){var n=(0,r.Z)(u().mark((function n(t,r){var s,c,a,i,o,l;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:for(c=0;c<e.regexList.length&&!s;c+=1)s=e.regexList[c].exec(t);if(s){n.next=5;break}return console.log("Can't parse ".concat(t,", skip")),n.abrupt("return");case 5:a=s.groups,i=a.group,o=a.device,console.log("Found: ".concat(i,"/").concat(o)),console.log(r.toString()),l=JSON.parse(r),e.groupDeviceMap[i]=e.groupDeviceMap[i]||{},e.groupDeviceMap[i][o]=l,l.group=i,l.device=o;case 13:case"end":return n.stop()}}),n)})));return function(e,t){return n.apply(this,arguments)}}())})));case 3:case"end":return n.stop()}}),n)})))()}},{key:"ssh",value:function(e,n,t){var s=this;return(0,r.Z)(u().mark((function c(){var a;return u().wrap((function(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,s.createSession(e,n,t,s.mqttConnStr);case 2:(a=c.sent).term=t,t.onKey(function(){var e=(0,r.Z)(u().mark((function e(n){var t;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s.sessionMap[a.uuid]){e.next=2;break}return e.abrupt("return");case 2:return t=n.key,e.next=5,a.mqttClient.publish("stunnelv1.0/".concat(a.group,"/").concat(a.device,"/").concat(a.uuid,"/1/in"),"".concat(t));case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 5:case"end":return c.stop()}}),c)})))()}},{key:"stop",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,w.map(Object.keys(e.sessionMap),function(){var n=(0,r.Z)(u().mark((function n(t){return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",e.destroySession(t));case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}());case 2:case"end":return n.stop()}}),n)})))()}},{key:"getGroupDeviceMap",value:function(){return(0,m.Z)({},this.groupDeviceMap)}},{key:"getGroupDeviceList",value:function(){var e=this,n=[];return Object.keys(this.groupDeviceMap).forEach((function(t){var r=e;Object.keys(e.groupDeviceMap[t]).forEach((function(e){n.push(r.groupDeviceMap[t][e])}))})),n}}]),e}(),k=b,y=function(e){(0,a.Z)(o,e);var n=(0,i.Z)(o);function o(e){var t;(0,s.Z)(this,o),t=n.call(this,e);var r=new k;return t.state={term:null,smtunnel:r,isScanning:!1,connected:!1,deviceList:[]},t}return(0,c.Z)(o,[{key:"componentDidMount",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){var s,c,a,i;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=function(){var n=(0,r.Z)(u().mark((function n(){var r,s,c,a;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.e(142).then(t.t.bind(t,2320,23));case 2:return r=n.sent.Terminal,n.next=5,t.e(617).then(t.t.bind(t,2617,23));case 5:s=n.sent.FitAddon,c=new r({cursorBlink:"block"}),a=new s,c.loadAddon(a),e.setState({term:c,fitAddon:a});case 10:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}(),n.next=3,s();case 3:c=e.state,a=c.term,i=c.fitAddon,a.open(document.getElementById("xterm-container")),i.fit();case 6:case"end":return n.stop()}}),n)})))()}},{key:"handleMqttConnStrChange",value:function(e){this.mqttConnStr=e.target.value}},{key:"scan",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){var t;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.state.smtunnel,e.setState({isScanning:!0}),n.next=4,t.scan();case 4:e.setState({deviceList:t.getGroupDeviceList(),isScanning:!1});case 5:case"end":return n.stop()}}),n)})))()}},{key:"disconnect",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){var t;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.state.smtunnel,n.next=3,t.stop();case 3:e.setState({isScanning:!1,connected:!1});case 4:case"end":return n.stop()}}),n)})))()}},{key:"ssh",value:function(e,n){var t=this;return(0,r.Z)(u().mark((function r(){var s,c,a;return u().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return s=t.state,c=s.smtunnel,a=s.term,r.next=3,c.ssh(e,n,a);case 3:t.setState({isScanning:!1,connected:!0});case 4:case"end":return r.stop()}}),r)})))()}},{key:"render",value:function(){var e=this,n=this.state,t=n.fitAddon,s=n.smtunnel,c=n.deviceList,a=n.isScanning,i=n.connected,o=this;return(0,l.jsxs)("div",{"data-theme":"dracula",className:"container flex flex-col space-y-4 h-screen w-screen",children:[(0,l.jsxs)(d(),{children:[(0,l.jsx)("title",{children:"smtunnel web console"}),(0,l.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,l.jsx)("div",{className:"navbar bg-neutral text-neutral-content",children:(0,l.jsx)("a",{className:"btn btn-ghost normal-case text-xl",href:"/",children:"SSH via smtunnel"})}),(0,l.jsxs)(h.e,{className:"border-red-600",width:350,height:450,style:{padding:"0.4em",margin:"1em"},children:[(0,l.jsx)("div",{id:"xterm-container",style:{height:"100%",width:"100%"}}),(0,l.jsx)(v.Z,{onResize:function(){t&&t.fit()},onPosition:function(){}})]}),(0,l.jsx)("div",{className:"divider",children:"Settings"}),(0,l.jsxs)("div",{className:"grid grid-cols-2",children:[(0,l.jsx)("div",{children:(0,l.jsx)("input",{type:"text",placeholder:"ws://10.123.12.140:8083/mqtt",className:"input input-bordered w-full",disabled:i||a,onChange:this.handleMqttConnStrChange.bind(s)})}),(0,l.jsxs)("div",{className:"btn-group",children:[(0,l.jsx)("button",{type:"button",className:"btn btn-primary w-1/2",disabled:i||a,onClick:function(){return e.scan()},children:"Start / Scan"}),(0,l.jsx)("button",{type:"button",className:"btn btn-secondary w-1/2",onClick:function(){return e.disconnect()},children:"Disconnect"})]})]}),(0,l.jsx)("div",{className:"overflow-x-auto",children:(0,l.jsxs)("table",{className:"table table-compact w-full",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"#"}),(0,l.jsx)("th",{children:"Group"}),(0,l.jsx)("th",{children:"Device"}),(0,l.jsx)("th",{children:"Service"}),(0,l.jsx)("th",{children:"Status"})]})}),(0,l.jsx)("tbody",{children:c.map((function(e){return(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"#"}),(0,l.jsx)("td",{children:e.group}),(0,l.jsx)("td",{children:e.device}),(0,l.jsx)("td",{children:(0,l.jsx)("button",{type:"button",className:"btn btn-primary",disabled:i||"connected"!==e.status,onClick:(0,r.Z)(u().mark((function n(){return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",o.ssh(e.group,e.device));case 1:case"end":return n.stop()}}),n)}))),children:"SSH"})}),(0,l.jsx)("td",{children:e.status})]},"".concat(e.group,"-").concat(e.device))}))})]})}),a?(0,l.jsx)("progress",{className:"progress progress-info"}):""]})}}]),o}(f.Component)},1784:function(){},5036:function(){},2361:function(){},4616:function(){}},function(e){e.O(0,[831,669,774,888,179],(function(){return n=5557,e(e.s=n);var n}));var n=e.O();_N_E=n}]);