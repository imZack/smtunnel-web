(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{5557:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return t(2362)}])},2362:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return y}});var r=t(7568),c=t(1438),s=t(2951),i=t(8029),o=t(6567),a=t(4051),u=t.n(a),l=t(5893),p=t(9008),d=t.n(p),f=t(7294),h=t(6312),v=t(2893),x=t(4924),m=t(6042),g=t(7229),w=t(6624),b=function(){function e(n){(0,c.Z)(this,e),(0,x.Z)(this,"regexList",[RegExp("^stunnelv1\\.0\\/(?<group>.+?)\\/(?<device>.+?)\\/(?<uuid>.+)\\/(?<session>.+)\\/(?<action>.+)$"),RegExp("^stunnelv1\\.0\\/(?<group>.+?)\\/(?<device>.+?)\\/state$")]),this.sessionMap={},this.groupDeviceMap={},this.mqttConnStr=n||"ws://10.123.12.140:8083/mqtt",this.connceted=!1}return(0,s.Z)(e,[{key:"createSession",value:function(e,n,t,c){var s=this;return(0,r.Z)(u().mark((function i(){var o,a;return u().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return console.log("createSession [".concat(e,"/").concat(n,"] mqtt://").concat(c)),o=window.crypto.randomUUID(),s.sessionMap[o]={uuid:o,group:e,device:n,term:t,mqttClient:g.connect(c,{keepalive:60,will:{topic:"stunnelv1.0/".concat(e,"/").concat(n,"/").concat(o,"/logout"),payload:null,qos:1}}),write:[],read:[]},(a=s.sessionMap[o]).mqttClient.on("message",function(){var e=(0,r.Z)(u().mark((function e(n,t){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a.term){e.next=4;break}return console.log("session.term not existed. buffering..."),a.write.push(t.toString()),e.abrupt("return");case 4:return e.next=6,a.term.write(a.write.join(""));case 6:return a.write.length=0,e.next=9,a.term.write(t.toString());case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}()),i.next=7,a.mqttClient.subscribe("stunnelv1.0/".concat(e,"/").concat(n,"/").concat(o,"/1/out"));case 7:return i.next=9,a.mqttClient.publish("stunnelv1.0/".concat(a.group,"/").concat(a.device,"/").concat(o,"/login"),JSON.stringify({id:o,online:!0,maxPacketSize:0,sshDirect:!0}));case 9:return i.abrupt("return",a);case 10:case"end":return i.stop()}}),i)})))()}},{key:"destroySession",value:function(e){var n=this;return(0,r.Z)(u().mark((function t(){var r;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("destroySession",e),r=n.sessionMap[e],t.next=4,r.mqttClient.end();case 4:r.term.reset(),delete n.sessionMap[e];case 6:case"end":return t.stop()}}),t)})))()}},{key:"scan",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){var t;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log("scan started."),(t=g.connect(e.mqttConnStr)).on("connect",(0,r.Z)(u().mark((function e(){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Broker connected."),e.next=3,t.subscribe("stunnelv1.0/+/+/state",(function(e){e?console.error(e):console.log("topic [stunnelv1.0/+/+/state] subscribed.")}));case 3:case"end":return e.stop()}}),e)})))),t.on("message",function(){var n=(0,r.Z)(u().mark((function n(t,r){var c,s,i,o,a,l;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:for(s=0;s<e.regexList.length&&!c;s+=1)c=e.regexList[s].exec(t);if(c){n.next=5;break}return console.log("Can't parse ".concat(t,", skip")),n.abrupt("return");case 5:i=c.groups,o=i.group,a=i.device,console.log("Found: ".concat(o,"/").concat(a)),console.log(r.toString()),l=JSON.parse(r),e.groupDeviceMap[o]=e.groupDeviceMap[o]||{},e.groupDeviceMap[o][a]=l,l.group=o,l.device=a;case 13:case"end":return n.stop()}}),n)})));return function(e,t){return n.apply(this,arguments)}}()),n.next=6,new w((function(e){return setTimeout(e,3e3)}));case 6:return t.end(),console.log("scan ended."),n.abrupt("return",e.groupDeviceMap);case 9:case"end":return n.stop()}}),n)})))()}},{key:"ssh",value:function(e,n,t){var c=this;return(0,r.Z)(u().mark((function s(){var i;return u().wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,c.createSession(e,n,t,c.mqttConnStr);case 2:(i=s.sent).term=t,t.onKey(function(){var e=(0,r.Z)(u().mark((function e(n){var t;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c.sessionMap[i.uuid]){e.next=2;break}return e.abrupt("return");case 2:return t=n.key,e.next=5,i.mqttClient.publish("stunnelv1.0/".concat(i.group,"/").concat(i.device,"/").concat(i.uuid,"/1/in"),"".concat(t));case 5:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 5:case"end":return s.stop()}}),s)})))()}},{key:"stop",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,w.map(Object.keys(e.sessionMap),function(){var n=(0,r.Z)(u().mark((function n(t){return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",e.destroySession(t));case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}());case 2:case"end":return n.stop()}}),n)})))()}},{key:"getGroupDeviceMap",value:function(){return(0,m.Z)({},this.groupDeviceMap)}},{key:"getGroupDeviceList",value:function(){var e=this,n=[];return Object.keys(this.groupDeviceMap).forEach((function(t){var r=e;Object.keys(e.groupDeviceMap[t]).forEach((function(e){n.push(r.groupDeviceMap[t][e])}))})),n}}]),e}(),k=b,y=function(e){(0,i.Z)(a,e);var n=(0,o.Z)(a);function a(e){var t;(0,c.Z)(this,a),t=n.call(this,e);var r=new k;return t.state={term:null,smtunnel:r,deviceList:[]},t}return(0,s.Z)(a,[{key:"componentDidMount",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){var c,s,i,o;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return c=function(){var n=(0,r.Z)(u().mark((function n(){var r,c,s,i;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.e(142).then(t.t.bind(t,2320,23));case 2:return r=n.sent.Terminal,n.next=5,t.e(617).then(t.t.bind(t,2617,23));case 5:c=n.sent.FitAddon,s=new r({cursorBlink:"block"}),i=new c,s.loadAddon(i),e.setState({term:s,fitAddon:i});case 10:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}(),n.next=3,c();case 3:s=e.state,i=s.term,o=s.fitAddon,i.open(document.getElementById("xterm-container")),o.fit();case 6:case"end":return n.stop()}}),n)})))()}},{key:"handleMqttConnStrChange",value:function(e){this.mqttConnStr=e.target.value}},{key:"scan",value:function(){var e=this;return(0,r.Z)(u().mark((function n(){var t;return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t=e.state.smtunnel,n.next=3,t.scan();case 3:e.setState({deviceList:t.getGroupDeviceList()});case 4:case"end":return n.stop()}}),n)})))()}},{key:"render",value:function(){var e=this,n=this.state,t=n.fitAddon,c=n.smtunnel,s=n.term,i=n.deviceList;return(0,l.jsxs)("div",{className:"container flex flex-col space-y-4",children:[(0,l.jsxs)(d(),{children:[(0,l.jsx)("title",{children:"smtunnel web console"}),(0,l.jsx)("link",{rel:"icon",href:"/favicon.ico"})]}),(0,l.jsx)("h1",{className:"text-2xl",children:"SSH Terminal"}),(0,l.jsxs)(h.e,{width:350,height:350,style:{padding:"0.4em",margin:"1em"},children:[(0,l.jsx)("div",{id:"xterm-container",style:{overflow:"hidden",height:"100%",width:"100%"}}),(0,l.jsx)(v.Z,{onResize:function(){t&&t.fit()},onPosition:function(){}})]}),(0,l.jsxs)("div",{className:"grid grid-cols-2",children:[(0,l.jsx)("div",{children:(0,l.jsx)("input",{type:"text",placeholder:"ws://10.123.12.140:8083/mqtt",className:"input input-bordered w-full max-w-xs",value:c.mqttConnStr,onChange:this.handleMqttConnStrChange.bind(c)})}),(0,l.jsxs)("div",{className:"content-evenly",children:[(0,l.jsx)("button",{type:"button",className:"btn btn-primary",onClick:function(){return e.scan()},children:"Start / Scan"}),(0,l.jsx)("button",{type:"button",className:"btn btn-primary",onClick:c.stop.bind(c),children:"Disconnect"})]})]}),(0,l.jsx)("div",{className:"overflow-x-auto",children:(0,l.jsxs)("table",{className:"table table-compact w-full",children:[(0,l.jsx)("thead",{children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"#"}),(0,l.jsx)("th",{children:"Group"}),(0,l.jsx)("th",{children:"Device"}),(0,l.jsx)("th",{children:"Service"}),(0,l.jsx)("th",{children:"Status"})]})}),(0,l.jsx)("tbody",{children:i.map((function(e){return(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{children:"#"}),(0,l.jsx)("td",{children:e.group}),(0,l.jsx)("td",{children:e.device}),(0,l.jsx)("td",{children:(0,l.jsx)("button",{type:"button",className:"btn btn-primary",onClick:(0,r.Z)(u().mark((function n(){return u().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",c.ssh.apply(c,[e.group,e.device,s]));case 1:case"end":return n.stop()}}),n)}))),children:"SSH"})}),(0,l.jsx)("td",{children:e.status})]},"".concat(e.group,"-").concat(e.device))}))})]})})]})}}]),a}(f.Component)},1784:function(){},5036:function(){},2361:function(){},4616:function(){}},function(e){e.O(0,[831,669,774,888,179],(function(){return n=5557,e(e.s=n);var n}));var n=e.O();_N_E=n}]);